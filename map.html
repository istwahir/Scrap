<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recycling Drop-off Points - Kiambu Recycling & Scraps</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        #map {
            height: calc(100vh - 4rem);
        }
        .custom-popup .leaflet-popup-content {
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Navigation Bar -->
    <nav class="bg-green-600 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">Kiambu Recycling</h1>
            <button id="locateBtn" class="bg-green-700 px-4 py-2 rounded-lg hover:bg-green-800">
                üìç My Location
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto p-4">
        <!-- Filters -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-4">
            <div class="flex flex-wrap gap-2">
                <label class="inline-flex items-center">
                    <input type="checkbox" class="material-filter" value="plastic" checked
                           class="form-checkbox h-5 w-5 text-green-600">
                    <span class="ml-2">Plastic</span>
                </label>
                <label class="inline-flex items-center">
                    <input type="checkbox" class="material-filter" value="paper" checked
                           class="form-checkbox h-5 w-5 text-green-600">
                    <span class="ml-2">Paper</span>
                </label>
                <label class="inline-flex items-center">
                    <input type="checkbox" class="material-filter" value="metal" checked
                           class="form-checkbox h-5 w-5 text-green-600">
                    <span class="ml-2">Metal</span>
                </label>
                <label class="inline-flex items-center">
                    <input type="checkbox" class="material-filter" value="glass" checked
                           class="form-checkbox h-5 w-5 text-green-600">
                    <span class="ml-2">Glass</span>
                </label>
                <label class="inline-flex items-center">
                    <input type="checkbox" class="material-filter" value="electronics" checked
                           class="form-checkbox h-5 w-5 text-green-600">
                    <span class="ml-2">Electronics</span>
                </label>
            </div>
        </div>

        <!-- Map -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div id="map"></div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Initialize map
        const map = L.map('map').setView([-1.171315, 36.835372], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        // Custom marker icons
        const dropoffIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
        });

        let markers = [];
        let userMarker = null;
        let userPosition = null;

        // Load drop-off points
        async function loadDropoffs() {
            try {
                const filters = Array.from(document.querySelectorAll('.material-filter:checked'))
                    .map(cb => cb.value)
                    .join(',');
                
                let url = 'api/get_dropoffs.php';
                if (userPosition) {
                    url += `?lat=${userPosition.lat}&lng=${userPosition.lng}&materials=${filters}`;
                }

                const response = await fetch(url);
                const data = await response.json();

                // Clear existing markers
                markers.forEach(marker => marker.remove());
                markers = [];

                if (data.status === 'success') {
                    data.data.forEach(point => {
                        const marker = L.marker([point.lat, point.lng], {icon: dropoffIcon})
                            .addTo(map);

                        // Create popup content
                        const popupContent = `
                            <div class="p-4 min-w-[200px]">
                                <h3 class="font-bold text-lg mb-2">${point.name}</h3>
                                <p class="text-gray-600 mb-2">${point.address}</p>
                                <p class="text-sm mb-2">
                                    <span class="font-semibold">Materials:</span><br>
                                    ${point.materials.join(', ')}
                                </p>
                                <p class="text-sm mb-2">
                                    <span class="font-semibold">Hours:</span><br>
                                    ${point.operating_hours}
                                </p>
                                <p class="text-sm">
                                    <span class="font-semibold">Contact:</span><br>
                                    ${point.contact_phone}
                                </p>
                                ${point.distance ? `
                                <p class="mt-2 text-green-600 font-semibold">
                                    Distance: ${point.distance} km
                                </p>
                                ` : ''}
                                <button onclick="createRequest('${point.id}')"
                                        class="mt-4 bg-green-600 text-white px-4 py-2 rounded-lg w-full hover:bg-green-700">
                                    Request Pickup
                                </button>
                            </div>
                        `;

                        marker.bindPopup(popupContent, {
                            className: 'custom-popup'
                        });
                        markers.push(marker);
                    });
                }
            } catch (error) {
                console.error('Failed to load drop-off points:', error);
            }
        }

        // Handle location button click
        document.getElementById('locateBtn').addEventListener('click', () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userPosition = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        // Update user marker
                        if (userMarker) {
                            userMarker.remove();
                        }
                        userMarker = L.marker([userPosition.lat, userPosition.lng])
                            .addTo(map)
                            .bindPopup('You are here')
                            .openPopup();

                        // Center map on user location
                        map.setView([userPosition.lat, userPosition.lng], 13);

                        // Reload drop-offs with distance
                        loadDropoffs();
                    },
                    (error) => {
                        console.error('Error getting location:', error);
                        alert('Could not get your location. Please try again.');
                    }
                );
            } else {
                alert('Geolocation is not supported by your browser');
            }
        });

        // Handle filter changes
        document.querySelectorAll('.material-filter').forEach(checkbox => {
            checkbox.addEventListener('change', loadDropoffs);
        });

        // Create request function (to be implemented)
        function createRequest(dropoffId) {
            // Check if user is logged in
            const isLoggedIn = false; // Replace with actual session check
            
            if (!isLoggedIn) {
                window.location.href = '/login.html?redirect=map&dropoff=' + dropoffId;
                return;
            }
            
            window.location.href = '/request.html?dropoff=' + dropoffId;
        }

        // Initial load
        loadDropoffs();

        // Add PWA support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registered:', registration);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
